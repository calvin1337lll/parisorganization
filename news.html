<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أخبار باريس الرسمية</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="news-page-layout">
    <div class="news-app-wrapper">
        <header class="news-header">
            <div class="header-right">
                <div class="menu-icon" onclick="toggleNewsSidebar()"><i class="fas fa-bars"></i></div>
                <a href="index.html" class="back-btn-link"><i class="fas fa-arrow-right"></i> العودة للرئيسية</a>
            </div>
            <h2 id="newsTitle">الأخبار العامة</h2>
            <div class="user-info-small" id="uNameSmall">تحميل...</div>
        </header>

        <div class="news-main-container">
            <aside id="newsSidebar" class="news-side-menu">
                <button onclick="changeCategory('public')"><i class="fas fa-globe"></i> الأخبار العامة</button>
                <button onclick="changeCategory('absent')"><i class="fas fa-user-clock"></i> أخبار الغيابات</button>
            </aside>

            <main class="news-content-area">
                <div id="newsList"></div>
                <div id="publisherArea" style="display:none;" class="publisher-box">
                    <textarea id="newsInput" placeholder="اكتب الخبر هنا..."></textarea>
                    <button class="send-btn" onclick="publishNews()">نشر الخبر</button>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCQ-8xDBbTDugkwdJMT6BbnaW5aQxufbf4",
            databaseURL: "https://webparis-ef921-default-rtdb.firebaseio.com",
            projectId: "webparis-ef921",
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const user = JSON.parse(sessionStorage.getItem('paris_session'));
        let currentTab = 'public';

        if(!user) window.location.href = 'login.html';

        document.getElementById('uNameSmall').innerText = user.user;

        // دالة التبديل
        window.toggleNewsSidebar = () => {
            const side = document.getElementById('newsSidebar');
            side.classList.toggle('active');
        };

        window.changeCategory = (cat) => {
            currentTab = cat;
            document.getElementById('newsTitle').innerText = cat === 'public' ? "الأخبار العامة" : "أخبار الغيابات";
            loadNews();
            if(window.innerWidth < 768) toggleNewsSidebar();
        };

        function loadNews() {
            const list = document.getElementById('newsList');
            onValue(ref(db, 'news/' + currentTab), (snap) => {
                let html = "";
                const data = snap.val();
                if(data) {
                    Object.keys(data).reverse().forEach(id => {
                        const post = data[id];
                        html += `
                            <div class="news-card">
                                ${user.rank === 'OWNER' ? `<i class="fas fa-trash del" onclick="deletePost('${id}')"></i>` : ''}
                                <div class="post-meta"><span>${post.author}</span> • <span>${post.date}</span></div>
                                <p>${post.text}</p>
                            </div>`;
                    });
                } else html = "<p class='empty'>لا توجد أخبار حالياً</p>";
                list.innerHTML = html;
            });

            if(user.rank === 'OWNER') document.getElementById('publisherArea').style.display = 'block';
        }

        window.publishNews = () => {
            const text = document.getElementById('newsInput').value;
            if(!text) return;
            set(ref(db, `news/${currentTab}/${Date.now()}`), {
                text, author: user.user, date: new Date().toLocaleString('ar-EG')
            });
            document.getElementById('newsInput').value = "";
        };

        window.deletePost = (id) => {
            if(confirm("حذف؟")) remove(ref(db, `news/${currentTab}/${id}`));
        };

        loadNews();
    </script>
</body>
</html>